{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CLIMA CHILE - Pron√≥stico</title>

  <!-- CSS global del proyecto -->
  <link rel="stylesheet" href="{% static 'css/detalle.css' %}">

  <!-- Ajustes visuales espec√≠ficos (mismos que resultados) -->
  <style>
    .btn-clean{
      display:inline-block;
      padding:12px 18px;
      background:#101318; color:#fff;
      border:0; border-radius:8px;
      font-weight:700; cursor:pointer; text-decoration:none;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      transition:background .2s ease, transform .05s ease;
    }
    .btn-clean:hover{ background:#2a3b4f; }
    .btn-clean:active{ transform:translateY(1px); }
    .btn-clean:disabled{ opacity:.5; cursor:not-allowed; }

    .btn-lg{ padding:14px 22px; font-size:1rem; }

    .mode-switch{ display:inline-flex; border-radius:10px; overflow:hidden; }
    .mode-switch a, .mode-switch button{
      padding:12px 18px; background:#101318; color:#fff;
      border:none; font-weight:700; cursor:pointer; text-decoration:none;
    }
    .mode-switch button.active{ background:#2a3b4f; }
    .mode-switch a:hover, .mode-switch button:not(.active):hover{ background:#2a3b4f; }

    .controls-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 14px; }

    /* Chips para offsets */
    .pill{
      padding:8px 12px; border-radius:999px;
      background:#fff; color:#333; border:1px solid #e1e5ee; cursor:pointer; font-weight:700;
      box-shadow:0 1px 4px rgba(0,0,0,.08);
      user-select:none;
    }
    .pill.active{ background:#2a3b4f; color:#fff; border-color:#2a3b4f; }

    .footer-spacer{ height:30px; }
  </style>

  <!-- Leaflet (mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>

<body style="background-image: url('{% static 'img/' %}{{ data.imagen_fondo }}'); background-size: cover; background-position: center;">
  <div class="card-container">
    <div class="card-detalle">

      <!-- Encabezado -->
      <div class="header-detalle">
        <h1>CLIMA CHILE - Pron√≥stico y Datos Recientes</h1>
        <div class="subtitle">An√°lisis Diario - Regi√≥n de {{ data.region_nombre }}</div>
      </div>
      
      <img src="{% static 'img/logo.png' %}" 
      alt="logo" 
      style="position:absolute; top:0px; right:67px; width:190px; opacity:0.92; z-index:1000;">
      
      <!-- Barra de modo (A√±o/Mes llevan a resultados; Pron√≥stico activo) -->
      <div class="controls-row" style="justify-content:space-between;">
          <div class="mode-switch">
              <a class="btn-clean" href="{% url 'resultados_detalle' %}">Hist√≥rico (A√±o/Mes)</a>
              <button class="active" disabled>Pron√≥stico</button>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
              <a class="btn-clean" href="{% url 'consulta_clima' %}">Nueva Consulta</a>
              <a class="btn-clean btn-lg" href="{% url 'evolucion_historica' %}">Ver Evoluci√≥n Hist√≥rica</a>
          </div>
      </div>

      <!-- Controles de Pron√≥stico -->
      <div class="controls-row">
        <span class="pill" data-off="-14">-14</span>
        <span class="pill" data-off="-7">-7</span>
        <span class="pill active" data-off="0">Hoy</span>
        <span class="pill" data-off="7">+7</span>
        <span class="pill" data-off="14">+14</span>

        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <button id="btnPrevDay" class="btn-clean">‚üµ Anterior</button>
          <div style="font-weight:700">Fecha: <span id="lblFecha">{{ today_date_string }}</span></div>
          <button id="btnNextDay" class="btn-clean">Siguiente ‚ü∂</button>
        </div>
      </div>

      <!-- Cuerpo: mapa + m√©tricas -->
      <div class="content-grid">
        <div class="left-column">
          <h3>üåç Ubicaci√≥n Geogr√°fica</h3>
          <div id="map" class="map-section"></div>
        </div>

        <div class="metric-grid-clean">
          <div class="data-panel-clean warm-bg"><span>T¬∞ MEDIOD√çA (12PM)</span><span id="temp_12pm" class="metric-value-clean">--</span><span class="unit">¬∞C</span></div>
          <div class="data-panel-clean cold-bg"><span>T¬∞ TARDE (6PM)</span><span id="temp_6pm" class="metric-value-clean">--</span><span class="unit">¬∞C</span></div>
          <div class="data-panel-clean rain-bg"><span>PRECIPITACI√ìN SUMA</span><span id="precip_sum" class="metric-value-clean">--</span><span class="unit">mm</span></div>
          <div class="data-panel-clean moisture-bg"><span>HUMEDAD M√ÅXIMA</span><span id="humidity_max_abs" class="metric-value-clean">--</span><span class="unit">%</span></div>
          <div class="data-panel-clean wind-bg"><span>VIENTO M√ÅXIMO</span><span id="wind_max" class="metric-value-clean">--</span><span class="unit">km/h</span></div>
          <div class="data-panel-clean sun-bg"><span>RADIACI√ìN SOLAR</span><span id="radiation_sum" class="metric-value-clean">--</span><span class="unit">J/m¬≤</span></div>
          <div class="data-panel-clean extreme-bg"><span>T¬∞ M√ÅX ABSOLUTA</span><span id="temp_max_abs" class="metric-value-clean">--</span><span class="unit">¬∞C</span></div>
          <div class="data-panel-clean cold-bg"><span>T¬∞ M√çN ABSOLUTA</span><span id="temp_min_abs" class="metric-value-clean">--</span><span class="unit">¬∞C</span></div>
          <div class="data-panel-clean info-bg"><span>D√çAS EN EL PER√çODO</span><span id="num_dias" class="metric-value-clean">1</span><span class="unit">d√≠as</span></div>
        </div>
      </div>

      <div class="footer-spacer"></div>
      <a href="{% url 'resultados_detalle' %}" class="back-button">‚Üê Volver a Hist√≥rico Anual</a>

    </div>
  </div>

  <!-- === L√≥gica === -->
  <script>
    // Datos de contexto
    const REGION_CODE = "{{ data.region_code }}";
    const REGION_NAME = "{{ data.region_nombre }}";
    const LAT = {{ data.lat|floatformat:"6" }};
    const LON = {{ data.lon|floatformat:"6" }};
    let offset = 0;                  // -14..+14
    const MIN_OFF = -14, MAX_OFF = 14;

    /* ---------- MAPA ---------- */
    (function initMap(){
      const map = L.map('map', {zoomControl:true}).setView([LAT, LON], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18, attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      const marker = L.marker([LAT, LON]).addTo(map);
      marker.bindPopup(`${REGION_NAME}`).openPopup();
      setTimeout(()=> map.invalidateSize(), 300);
    })();

    /* ---------- M√âTRICAS ---------- */
    function setMetric(id, v){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (v === null || v === undefined) ? '--' : v;
    }
    function paintMetrics(m){
      setMetric('temp_12pm', m.temp_12pm);
      setMetric('temp_6pm', m.temp_6pm);
      setMetric('precip_sum', m.precip_sum);
      setMetric('wind_max', m.wind_max);
      setMetric('radiation_sum', m.radiation_sum);
      setMetric('temp_max_abs', m.temp_max_abs);
      setMetric('temp_min_abs', m.temp_min_abs);
      setMetric('humidity_max_abs', m.humidity_max_abs);
      setMetric('num_dias', m.num_dias ?? 1);
    }

    async function callForecast(days_offset){
      const res = await fetch("{% url 'fetch_pronostico_ajax' %}", {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ region_code: REGION_CODE, days_offset })
      });
      if(!res.ok) throw new Error('Error pron√≥stico');
      return res.json();
    }

    function updateNav(){
      document.getElementById('btnPrevDay').disabled = (offset <= MIN_OFF);
      document.getElementById('btnNextDay').disabled = (offset >= MAX_OFF);
      document.querySelectorAll('.pill').forEach(p=>{
        p.classList.toggle('active', parseInt(p.dataset.off,10) === offset);
      });
    }

    async function loadOffset(newOffset){
      offset = Math.max(MIN_OFF, Math.min(MAX_OFF, newOffset));
      updateNav();
      const r = await callForecast(offset);
      if(r?.success){
        paintMetrics(r.metrics);
        document.getElementById('lblFecha').textContent = r.periodo_label;
      }
    }

    // Eventos chips
    document.querySelectorAll('.pill').forEach(p=>{
      p.onclick = ()=> loadOffset(parseInt(p.dataset.off,10));
    });

    // Botones d√≠a a d√≠a
    document.getElementById('btnPrevDay').onclick = ()=> loadOffset(offset - 1);
    document.getElementById('btnNextDay').onclick = ()=> loadOffset(offset + 1);

    // Inicio
    loadOffset(0);
  </script>
</body>
</html>

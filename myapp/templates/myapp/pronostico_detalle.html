{% load static %}
<body style="background-image: url('{% static "img/"|add:data.imagen_fondo %}'); background-size: cover; background-position: center; background-attachment: fixed;">
    </body>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIMA CHILE - Pron√≥stico Diario</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/detalle.css' %}"> 
    
    <style>
        /* Estilos espec√≠ficos para el slider de d√≠as */
        .day-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
        }
        .day-slider-labels span:nth-child(2) {
            font-weight: bold;
            color: #007bff;
        }
        
        /* Estilo para la etiqueta superior (Ahora es un <h3>) */
        #dynamic-period-header {
            text-align: center;
            margin-bottom: 15px; 
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
        }
    </style>
</head>

<body style="background-image: url('{% static "img/"|add:data.imagen_fondo %}'); background-size: cover; background-position: center; background-attachment: fixed;">
    
    <div class="card-container">
        <div class="card-detalle"> 
            
            <div class="header-detalle">
                <h1>CLIMA CHILE - Pron√≥stico y Datos Recientes</h1>
                <p class="subtitle">An√°lisis Diario - Regi√≥n de {{ data.region_nombre }}</p>
            </div>
            
            <div class="content-grid">
                
                <div class="left-column">
                    <h2>üó∫Ô∏è Ubicaci√≥n Geogr√°fica</h2>
                    
                    <div id="mapid" class="map-section"></div>
                    
                    <div class="slider-container">
                        <h3 style="margin-bottom: 10px;">Selecci√≥n de D√≠a (-14 a +14)</h3>
                        
                        <h3 id="dynamic-period-header">Cargando...</h3> 

                        <input type="range" id="day-slider" min="-14" max="14" value="0" step="1">
                        
                        <div class="day-slider-labels"> 
                            <span>-14 d√≠as (Hist√≥rico)</span>
                            <span>Hoy</span>
                            <span style="float: right;">+14 d√≠as (Pron√≥stico)</span>
                        </div>
                    </div>

                    </div>
                
                <div class="stats-section">
                    <div class="stats-scroll-container">
                        <h2 id="stats-header">üìä Resumen Diario</h2> 
                        
                        <div class="metric-grid-clean">
                            <div class="data-panel-clean warm-bg">üå°Ô∏è <span>T¬∞ M√ÅX DIARIA</span> <span class="metric-value-clean" id="temp_max_avg">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean cold-bg">‚ùÑÔ∏è <span>T¬∞ M√çN DIARIA</span> <span class="metric-value-clean" id="temp_min_avg">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean rain-bg">üíß <span>PRECIPITACI√ìN SUMA</span> <span class="metric-value-clean" id="precip_sum">--</span> <span>mm</span></div>
                            <div class="data-panel-clean wind-bg">üí® <span>VIENTO M√ÅXIMO</span> <span class="metric-value-clean" id="wind_max">--</span> <span>km/h</span></div>
                            <div class="data-panel-clean sun-bg">‚òÄÔ∏è <span>RADIACI√ìN SOLAR</span> <span class="metric-value-clean" id="radiation_sum">--</span> <span>J/m¬≤</span></div>
                            <div class="data-panel-clean extreme-bg">üî• <span>T¬∞ M√ÅX ABSOLUTA</span> <span class="metric-value-clean" id="temp_max_abs">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean extreme-bg">ü•∂ <span>T¬∞ M√çN ABSOLUTA</span> <span class="metric-value-clean" id="temp_min_abs">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean info-bg">üóìÔ∏è <span>D√çAS EN EL PERIODO</span> <span class="metric-value-clean" id="num_dias">--</span> <span>d√≠as</span></div>
                        </div>
                        
                        <p id="loading-message" style="text-align: center; color: #007bff; margin-top: 20px; font-weight: 600; display: none;">Cargando datos...</p>
                        <p id="error-message" style="text-align: center; color: #dc3545; margin-top: 20px; font-weight: 600; display: none;">Error al cargar los datos.</p>
                        
                        <p style="font-size: 0.8rem; color: #666; text-align: right; margin-top: 30px;">Fuente: Open-Meteo</p>
                    </div>
                </div>
            </div>
            
            <hr>

            <a href="{% url 'resultados_detalle' %}" class="back-button">
                ‚Üê Volver a Hist√≥rico Anual
            </a>
            
        </div>
    </div>

    <script>
        // Par√°metros iniciales
        const params = {
            region_code: "{{ data.region_code|escapejs }}",
            lat: {{ data.lat }},
            lon: {{ data.lon }},
            regionNombre: "{{ data.region_nombre|escapejs }}",
        };

        const TODAY_DATE_STRING = "{{ today_date_string|escapejs }}";
        
        // ----------------------------------------------------
        // L√≥gica del Mapa Leaflet
        // ----------------------------------------------------
        function initializeMap() {
             try {
                const map = L.map('mapid').setView([params.lat, params.lon], 6); 

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                L.marker([params.lat, params.lon]).addTo(map)
                    .bindPopup(`<b>${params.regionNombre}</b>`).openPopup();
            } catch (e) {
                console.error("Error al inicializar el mapa Leaflet:", e);
                document.getElementById('mapid').innerHTML = '<p style="text-align:center; color:red; padding:20px;">Error al cargar el mapa. Verifique la conexi√≥n o el CSS.</p>';
            }
        }
        
        // ----------------------------------------------------
        // L√≥gica del Slider de D√≠as AJAX
        // ----------------------------------------------------
        const daySlider = document.getElementById('day-slider');
        // ‚úÖ Referencia a la nueva etiqueta din√°mica (h3)
        const dynamicPeriodHeader = document.getElementById('dynamic-period-header'); 
        const statsHeader = document.getElementById('stats-header');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');

        /**
         * Funci√≥n auxiliar para calcular la fecha a partir del offset.
         */
        function calculateDate(offset) {
            const today = new Date(TODAY_DATE_STRING);
            today.setDate(today.getDate() + offset);
            // Formato YYYY-MM-DD
            return today.toISOString().split('T')[0]; 
        }

        /**
         * Funci√≥n auxiliar para generar el texto de encabezado seg√∫n el offset.
         * @param {number} daysOffset - N√∫mero de d√≠as de diferencia con respecto a hoy (0).
         * @param {string} targetDate - Fecha en formato YYYY-MM-DD.
         * @returns {string} El texto formateado.
         */
        function formatHeaderText(daysOffset, targetDate) {
            if (daysOffset === 0) {
                return `Hoy (${targetDate})`;
            } else if (daysOffset < 0) {
                return `Hist√≥rico ${Math.abs(daysOffset)} d√≠as atr√°s (${targetDate})`;
            } else {
                return `Pron√≥stico en ${daysOffset} d√≠as (${targetDate})`;
            }
        }

        function updateMetricsDisplay(metrics) {
            const emptyValue = '--';
            if (!metrics || metrics.num_dias === undefined) { 
                document.getElementById('temp_max_avg').textContent = emptyValue;
                document.getElementById('temp_min_avg').textContent = emptyValue;
                document.getElementById('precip_sum').textContent = emptyValue;
                document.getElementById('wind_max').textContent = emptyValue;
                document.getElementById('radiation_sum').textContent = emptyValue;
                document.getElementById('temp_max_abs').textContent = emptyValue; 
                document.getElementById('temp_min_abs').textContent = emptyValue;
                document.getElementById('num_dias').textContent = emptyValue;
                return;
            }

            // Usamos toFixed(1) para todas las temperaturas y toFixed(1) para precipitaci√≥n y viento, asumiendo una decimal
            document.getElementById('temp_max_avg').textContent = metrics.temp_max_avg.toFixed(1);
            document.getElementById('temp_min_avg').textContent = metrics.temp_min_avg.toFixed(1);
            document.getElementById('precip_sum').textContent = metrics.precip_sum.toFixed(1);
            document.getElementById('wind_max').textContent = metrics.wind_max.toFixed(1);
            document.getElementById('radiation_sum').textContent = metrics.radiation_sum.toFixed(1);
            document.getElementById('temp_max_abs').textContent = metrics.temp_max_abs.toFixed(1); 
            document.getElementById('temp_min_abs').textContent = metrics.temp_min_abs.toFixed(1); 
            document.getElementById('num_dias').textContent = metrics.num_dias;
        }

        async function fetchDailyData(daysOffset) {
            
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';

            const url = "{% url 'fetch_pronostico_ajax' %}";
            const targetDate = calculateDate(daysOffset);
            
            const payload = {
                region_code: params.region_code,
                days_offset: daysOffset, 
            };
            
            // Usar el nuevo formato para el mensaje de carga
            const loadingText = formatHeaderText(daysOffset, targetDate);
            dynamicPeriodHeader.textContent = `Cargando: ${loadingText}`;
            statsHeader.textContent = `Cargando Resumen Diario (${targetDate})`;


            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // CSRF token es necesario si no se usa csrf_exempt o si se usa en producci√≥n
                        // 'X-CSRFToken': getCookie('csrftoken') // Si se incluye, necesitas la funci√≥n getCookie
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Actualiza la etiqueta con el texto final formateado
                    dynamicPeriodHeader.textContent = formatHeaderText(daysOffset, targetDate); 
                    statsHeader.textContent = `üìä Resumen ${formatHeaderText(daysOffset, targetDate)}`;
                    updateMetricsDisplay(data.metrics);
                } else {
                    errorMessage.textContent = data.message || "Error al obtener datos de la API. Intenta otro d√≠a.";
                    errorMessage.style.display = 'block';
                    updateMetricsDisplay(null); 
                }

            } catch (error) {
                console.error("Fetch error:", error);
                errorMessage.textContent = "Error de conexi√≥n o servidor.";
                errorMessage.style.display = 'block';
                updateMetricsDisplay(null);
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        /**
         * Listener 'input' (mientras se arrastra) - ACTUALIZA SOLO EL TEXTO
         */
        daySlider.addEventListener('input', (event) => {
            const daysOffset = parseInt(event.target.value);
            const targetDate = calculateDate(daysOffset);
            
            // ‚úÖ Usa el nuevo formato din√°mico
            const labelText = formatHeaderText(daysOffset, targetDate);
            
            dynamicPeriodHeader.textContent = labelText;
            statsHeader.textContent = `üìä Resumen ${labelText}`;
        });

        /**
         * Listener 'change' (cuando se suelta) - LLAMA A LA API
         */
        daySlider.addEventListener('change', (event) => {
            const daysOffset = parseInt(event.target.value);
            fetchDailyData(daysOffset);
        });

        // Cargar datos iniciales al entrar a la p√°gina (Hoy, offset 0) y el mapa
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();         // Inicializa el mapa
            fetchDailyData(0);       // Cargar datos de Hoy
        });

    </script>
</body>
</html>
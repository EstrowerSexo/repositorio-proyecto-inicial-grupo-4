{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIMA CHILE - Resultados Detalle</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/detalle.css' %}"> 
    
</head>

<body style="background-image: url('{% static "img/"|add:data.imagen_fondo %}'); background-size: cover; background-position: center; background-attachment: fixed;">
    
    <div class="card-container">
        <div class="card-detalle"> 
            
            <div class="header-detalle">
                <h1>CLIMA CHILE - Resultados Detalle</h1>
                <p class="subtitle">An√°lisis Hist√≥rico - Regi√≥n de {{ data.region_nombre }} ({{ data.a√±o }})</p>
            </div>
            
            <div class="content-grid">
                
                <div class="left-column">
                    <h2>üó∫Ô∏è Ubicaci√≥n Geogr√°fica</h2>
                    
                    <div id="mapid" class="map-section"></div>
                    
                    <div class="slider-container">
                        <h3 style="margin-bottom: 10px;">Selecci√≥n de Periodo Hist√≥rico</h3>
                        
                        <div id="month-label-wrapper"> 
                            <label for="month-slider" id="month-label">Periodo: **Anual**</label>
                        </div>

                        <input type="range" id="month-slider" min="0" max="13" value="0" step="1">
                        
                        <div class="month-labels-simple"> 
                            <span>Anual</span>
                            <span>Mensual</span>
                            <span style="float: right;">Actualidad</span>
                        </div>
                    </div>

                    <div id="forecast-block" class="forecast-container" 
                         style="{% if data.is_historical %} display: none; {% endif %}"
                    >
                        <h3 style="margin-bottom: 15px; color: #333;">Predicci√≥n a 7 D√≠as</h3>
                        {% if not data.is_historical %}
                            <div class="forecast-grid">
                                <p style="color: blue;">El pron√≥stico a 7 d√≠as a√∫n no est√° implementado.</p>
                            </div>
                        {% else %}
                            <p style="color: #666;">El pron√≥stico a 7 d√≠as no est√° disponible para el a√±o hist√≥rico **{{ data.a√±o }}**.</p>
                        {% endif %}
                    </div>

                </div>
                
                <div class="stats-section">
                    <div class="stats-scroll-container">
                        <h2 id="stats-header">üìä Resumen Anual</h2> 
                        
                        <div class="metric-grid-clean">
                            <div class="data-panel-clean warm-bg">üå°Ô∏è <span>T¬∞ M√ÅX PROMEDIO</span> <span class="metric-value-clean" id="temp_max_avg">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean cold-bg">‚ùÑÔ∏è <span>T¬∞ M√çN PROMEDIO</span> <span class="metric-value-clean" id="temp_min_avg">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean rain-bg">üíß <span>PRECIPITACI√ìN TOTAL</span> <span class="metric-value-clean" id="precip_sum">--</span> <span>mm</span></div>
                            <div class="data-panel-clean wind-bg">üí® <span>VIENTO M√ÅXIMO</span> <span class="metric-value-clean" id="wind_max">--</span> <span>km/h</span></div>
                            <div class="data-panel-clean sun-bg">‚òÄÔ∏è <span>RADIACI√ìN SOLAR TOTAL</span> <span class="metric-value-clean" id="radiation_sum">--</span> <span>J/m¬≤</span></div>
                            <div class="data-panel-clean extreme-bg">üî• <span>T¬∞ M√ÅX ABSOLUTA</span> <span class="metric-value-clean" id="temp_max_abs">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean extreme-bg">ü•∂ <span>T¬∞ M√çN ABSOLUTA</span> <span class="metric-value-clean" id="temp_min_abs">--</span> <span>¬∞C</span></div>
                            <div class="data-panel-clean info-bg">üóìÔ∏è <span>D√çAS EN EL PERIODO</span> <span class="metric-value-clean" id="num_dias">--</span> <span>d√≠as</span></div>
                        </div>
                        
                        <p id="loading-message" style="text-align: center; color: #007bff; margin-top: 20px; font-weight: 600; display: none;">Cargando datos...</p>
                        <p id="error-message" style="text-align: center; color: #dc3545; margin-top: 20px; font-weight: 600; display: none;">Error al cargar los datos.</p>
                        
                        <p style="font-size: 0.8rem; color: #666; text-align: right; margin-top: 30px;">Fuente: Open-Meteo</p>
                    </div>
                </div>
            </div>
            
            <hr>

            <a href="{% url 'consulta_clima' %}" class="back-button">
                ‚Üê Volver a Nueva Consulta
            </a>
            
        </div>
    </div>

    <script>
        // Par√°metros iniciales
        const params = {
            region_code: "{{ data.region_code|escapejs }}",
            year: {{ data.a√±o }},
            lat: {{ data.lat }},
            lon: {{ data.lon }},
            regionNombre: "{{ data.region_nombre|escapejs }}",
            isHistorical: {% if data.is_historical %}true{% else %}false{% endif %},
        };

        // ‚úÖ NUEVAS CONSTANTES: Variables de fecha del servidor
        const CURRENT_YEAR = {{ current_year }};
        const CURRENT_MONTH = {{ current_month }};
        const LIMIT_DATE_STRING = "{{ limit_date|escapejs }}"; // Fecha l√≠mite (hace 3 d√≠as)

        // Mapeo de meses para el slider (13 es "Actualidad")
        const months = [
            'Anual', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre', 'Actualidad'
        ];
        
        // ----------------------------------------------------
        // 1. L√≥gica del Mapa Leaflet
        // ----------------------------------------------------
        function initializeMap() {
             try {
                const map = L.map('mapid').setView([params.lat, params.lon], 6); 

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                L.marker([params.lat, params.lon]).addTo(map)
                    .bindPopup(`<b>${params.regionNombre}</b>`).openPopup();
            } catch (e) {
                console.error("Error al inicializar el mapa Leaflet:", e);
                document.getElementById('mapid').innerHTML = '<p style="text-align:center; color:red; padding:20px;">Error al cargar el mapa. Verifique la conexi√≥n o el CSS.</p>';
            }
        }
        
        // ----------------------------------------------------
        // 2. L√≥gica del Slider AJAX (Optimizado y Corregido)
        // ----------------------------------------------------
        const monthSlider = document.getElementById('month-slider');
        const monthLabel = document.getElementById('month-label');
        const statsHeader = document.getElementById('stats-header');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const forecastBlock = document.getElementById('forecast-block'); 

        function updateMetricsDisplay(metrics) {
            const emptyValue = '--';
            if (!metrics || metrics.temp_max_avg === '--') { 
                document.getElementById('temp_max_avg').textContent = emptyValue;
                document.getElementById('temp_min_avg').textContent = emptyValue;
                document.getElementById('precip_sum').textContent = emptyValue;
                document.getElementById('wind_max').textContent = emptyValue;
                document.getElementById('radiation_sum').textContent = emptyValue;
                document.getElementById('temp_max_abs').textContent = emptyValue;
                document.getElementById('temp_min_abs').textContent = emptyValue;
                document.getElementById('num_dias').textContent = emptyValue;
                return;
            }

            document.getElementById('temp_max_avg').textContent = metrics.temp_max_avg.toFixed(1);
            document.getElementById('temp_min_avg').textContent = metrics.temp_min_avg.toFixed(1);
            document.getElementById('precip_sum').textContent = metrics.precip_sum.toFixed(1);
            document.getElementById('wind_max').textContent = metrics.wind_max.toFixed(1);
            document.getElementById('radiation_sum').textContent = metrics.radiation_sum.toFixed(1);
            document.getElementById('temp_max_abs').textContent = metrics.temp_max_abs.toFixed(1);
            document.getElementById('temp_min_abs').textContent = metrics.temp_min_abs.toFixed(1);
            document.getElementById('num_dias').textContent = metrics.num_dias;
        }

        async function fetchData(monthValue) {
            
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';

            // 1. Determinar si es Forecast y el L√≠mite de Fecha
            const isForecast = monthValue === 13;
            let periodEnd = null; // Par√°metro para limitar el final del historial
            
            // Si es un a√±o hist√≥rico, no hay l√≠mite.
            // Si es el a√±o actual, aplicamos la l√≥gica.
            if (params.year === CURRENT_YEAR) {
                if (isForecast) {
                    // El forecast se maneja sin l√≠mite de fecha, la API usa el d√≠a actual.
                    periodEnd = null;
                }
                else if (monthValue === 0 || (monthValue >= 1 && monthValue <= CURRENT_MONTH)) {
                    // Si es Anual o un mes desde Enero hasta el mes actual, limitamos el final al l√≠mite (hace 3 d√≠as)
                    periodEnd = LIMIT_DATE_STRING; 
                } else if (monthValue > CURRENT_MONTH && monthValue !== 13) {
                    // Si el usuario intenta seleccionar un mes futuro del a√±o actual (Ej: Diciembre en Octubre)
                    errorMessage.textContent = `Error: Los datos hist√≥ricos de ${months[monthValue]} de ${CURRENT_YEAR} a√∫n no est√°n disponibles (l√≠mite: ${LIMIT_DATE_STRING}).`;
                    errorMessage.style.display = 'block';
                    loadingMessage.style.display = 'none';
                    updateMetricsDisplay(null);
                    return; // Salir de la funci√≥n sin hacer la petici√≥n
                }
            }


            // 2. Construir la Petici√≥n AJAX
            const url = "{% url 'fetch_clima_data_ajax' %}";
            const payload = {
                region_code: params.region_code,
                year: params.year,
                // Si es 'Actualidad' (13), enviamos 99 o alg√∫n valor que la vista de Django reconozca.
                // Usaremos 99, pero la bandera 'is_forecast' es el control principal.
                month: isForecast ? 99 : monthValue, 
                is_forecast: isForecast, 
                period_end: periodEnd, // Env√≠a el l√≠mite de fecha (LIMIT_DATE_STRING o null)
            };
            
            // Manejar el display de Forecast/Hist√≥rico
            if (isForecast) {
                forecastBlock.style.display = 'block';
                monthLabel.textContent = `Periodo: Actualidad (Pron√≥stico)`;
                statsHeader.textContent = `üìä Resumen Pron√≥stico`;
            } else {
                forecastBlock.style.display = 'none';
            }


            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    monthLabel.textContent = `Periodo: ${data.periodo_label}`;
                    statsHeader.textContent = `üìä Resumen ${data.periodo_label}`;
                    updateMetricsDisplay(data.metrics);
                } else {
                    errorMessage.textContent = data.message || "Error al obtener datos de la API. Intenta otro periodo.";
                    errorMessage.style.display = 'block';
                    updateMetricsDisplay(null); 
                }

            } catch (error) {
                console.error("Fetch error:", error);
                errorMessage.textContent = "Error de conexi√≥n o servidor.";
                errorMessage.style.display = 'block';
                updateMetricsDisplay(null);
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        /**
         * Listener 'input' (mientras se arrastra)
         */
        monthSlider.addEventListener('input', (event) => {
            const value = parseInt(event.target.value);
            if (value === 13) {
                monthLabel.textContent = `Cargando: Actualidad`;
                statsHeader.textContent = `Cargando Resumen Actualidad`;
            } else {
                monthLabel.textContent = `Cargando: ${months[value]}`;
                statsHeader.textContent = `Cargando Resumen ${months[value]}`;
            }
        });

        /**
         * Listener 'change' (cuando se suelta)
         * Llama a la funci√≥n de obtenci√≥n de datos para cargar las m√©tricas.
         */
        monthSlider.addEventListener('change', (event) => {
            const value = parseInt(event.target.value);
            fetchData(value);
        });

        // Cargar datos iniciales al entrar a la p√°gina (Anual) y el mapa
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();         // Inicializa el mapa
            fetchData(0);            // Cargar datos anuales (mes 0)
        });

    </script>
</body>
</html>
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIMA CHILE - Resultados Detalle</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/detalle.css' %}"> 
    
</head>
<body style="background-image: url('{% static "img/"|add:data.imagen_fondo %}'); background-size: cover; background-position: center; background-attachment: fixed;">
    
    <div class="card-container">
        <div class="card-detalle"> 
            
            <div class="header-detalle">
                <h1>CLIMA CHILE - Resultados Detalle</h1>
                <p class="subtitle">An√°lisis Hist√≥rico y Pron√≥stico - Regi√≥n de **{{ data.region_nombre }}** ({{ data.a√±o }})</p>
                <hr>
            </div>
            
            <div class="content-grid">
                
                <div class="left-column">
                    <h2>üó∫Ô∏è Regi√≥n de B√∫squeda</h2>
                    
                    <div id="mapid" class="map-section">
                        </div>
                    
                    {% if not data.is_historical %}
                        <div class="forecast-container">
                            <h3 style="margin-bottom: 15px; color: #333;">Predicci√≥n a 7 D√≠as</h3>
                            <div class="forecast-grid">
                                {% for day in data.forecast %} 
                                    <div class="forecast-day">
                                        <h4>{{ day.dia|date:"D d/m" }}</h4> 
                                        <p>{{ day.wmo_code|default:"N/A" }}</p> 
                                        <p class="temp-range">{{ day.temp_min|floatformat:0 }}¬∞C / {{ day.temp_max|floatformat:0 }}¬∞C</p>
                                        <p class="precip">Lluvia: {{ day.precipitacion|floatformat:1 }} mm</p>
                                    </div>
                                {% empty %}
                                    <p style="color: blue;">El pron√≥stico para el a√±o **{{ data.a√±o }}** est√° pendiente de implementaci√≥n. (No se pudo obtener el pron√≥stico a 7 d√≠as.)</p>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="forecast-container">
                            <h3 style="margin-bottom: 15px; color: #333;">Predicci√≥n a 7 D√≠as</h3>
                            <p style="color: #666;">El pron√≥stico a 7 d√≠as no est√° disponible para el a√±o hist√≥rico **{{ data.a√±o }}**.</p>
                        </div>
                    {% endif %}

                    <div class="slider-container">
                        <h3 style="margin-bottom: 10px;">Selecci√≥n de Periodo Hist√≥rico</h3>
                        <label for="month-slider" id="month-label" style="font-weight: bold;">Periodo: Anual</label>
                        <input type="range" id="month-slider" min="0" max="12" value="0" step="1">
                        <div class="month-labels">
                            <span>Anual</span>
                            <span>Enero</span>
                            <span>...</span>
                            <span>Diciembre</span>
                        </div>
                    </div>

                </div>
                
                <div class="stats-section">
                    
                    <div class="stats-scroll-container">
                        <h2>üìä M√©tricas Clave Anuales</h2>
                        
                        <div class="metric-grid">
                            
                            <div class="key-metric">
                                <span>Temperatura M√°xima Anual:</span> 
                                <span>**{{ data.temp_max_anual }} ¬∞C**</span>
                            </div>
                            
                            <div class="key-metric">
                                <span>Precipitaci√≥n Total Anual:</span> 
                                <span>**{{ data.precipitacion_total }} mm**</span>
                            </div>

                            <div class="key-metric">
                                <span>Velocidad Viento M√°x:</span> 
                                <span>**{{ data.wind_speed_max }} km/h**</span>
                            </div>

                            <div class="key-metric">
                                <span>Radiaci√≥n Solar Total:</span> 
                                <span>**{{ data.radiacion_total }} J/m¬≤**</span>
                            </div>
                        </div>

                        <p style="font-size: 0.8rem; color: #666; text-align: right;">Fuente: {{ data.fuente }}</p>
                        
                        <h3 style="margin-top: 30px;">Tablas Estad√≠sticas Mensuales</h3>
                        <p style="font-size: 0.9rem; color: #666;">**NOTA:** La tabla de datos hist√≥ricos mensuales se actualiza din√°micamente al mover el *slider*.</p>
                        
                        <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #007bff; color: white;">
                                    <th style="padding: 10px;">Mes</th>
                                    <th style="padding: 10px;">T¬∞ M√°x Prom.</th>
                                    <th style="padding: 10px;">Precip. Total</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-data-table">
                                <tr><td colspan="3" style="text-align: center; padding: 10px;">Datos disponibles al elegir un mes.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <hr>

            <a href="{% url 'consulta_clima' %}" class="back-button">
                ‚Üê Volver a Nueva Consulta
            </a>
            
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. L√≥gica del Mapa Leaflet
        // ----------------------------------------------------
        const lat = {{ data.lat }};
        const lon = {{ data.lon }};
        const regionNombre = "{{ data.region_nombre }}";

        try {
            // Se usa un zoom m√°s apropiado para regiones (ej: 6)
            const map = L.map('mapid').setView([lat, lon], 6); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([lat, lon]).addTo(map)
                .bindPopup(`<b>${regionNombre}</b>`).openPopup();
        } catch (e) {
            console.error("Error al inicializar el mapa Leaflet:", e);
            document.getElementById('mapid').innerHTML = '<p style="text-align:center; color:red; padding:20px;">Error al cargar el mapa. Verifique la conexi√≥n o la librer√≠a Leaflet.</p>';
        }

        // ----------------------------------------------------
        // 2. L√≥gica del Slider de Mes (Ahora funcional con datos reales)
        // ----------------------------------------------------
        // üí° NUEVO: Parsear la cadena JSON con los datos mensuales pre-calculados por Django
        const monthlyMetrics = JSON.parse('{{ monthly_metrics_json|escapejs }}'); 
        const tempMaxAnual = {{ data.temp_max_anual|default:0 }};
        const precipTotalAnual = {{ data.precipitacion_total|default:0 }};

        const monthSlider = document.getElementById('month-slider');
        const monthLabel = document.getElementById('month-label');
        const tableBody = document.getElementById('monthly-data-table');
        
        const months = [
            'Anual', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        function updateMonthData(value) {
            monthLabel.textContent = `Periodo: ${months[value]}`;
            
            if (value === 0) {
                // Opci√≥n Anual: Muestra el resumen total
                tableBody.innerHTML = `
                    <tr>
                        <td style="padding: 10px;">Anual</td>
                        <td style="padding: 10px;">${tempMaxAnual} ¬∞C</td>
                        <td style="padding: 10px;">${precipTotalAnual} mm</td>
                    </tr>
                `;
            } else {
                // Opci√≥n Mensual: Usa los datos pre-calculados de Django
                const monthKey = value.toString(); // Las claves del diccionario son strings (ej: '1', '2')
                const monthData = monthlyMetrics[monthKey];
                
                if (monthData) {
                    tableBody.innerHTML = `
                        <tr>
                            <td style="padding: 10px;">${months[value]}</td>
                            <td style="padding: 10px;">${monthData.temp_avg} ¬∞C</td>
                            <td style="padding: 10px;">${monthData.precip_sum} mm</td>
                        </tr>
                    `;
                } else {
                    // Si no hay datos (ej: el API no los devolvi√≥ por alg√∫n error)
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 10px;">No hay datos para este mes.</td></tr>';
                }
            }
        }

        monthSlider.addEventListener('input', (event) => {
            const value = parseInt(event.target.value);
            updateMonthData(value);
        });

        // Inicializar el slider en 'Anual' al cargar la p√°gina
        updateMonthData(0);

    </script>
</body>
</html>
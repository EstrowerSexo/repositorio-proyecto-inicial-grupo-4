{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CLIMA CHILE - Resultados Detalle</title>

  <!-- Estilos globales del proyecto -->
  <link rel="stylesheet" href="{% static 'css/detalle.css' %}">

  <!-- Ajustes visuales espec√≠ficos pedidos -->
  <style>
    /* wea para cambiar el a√±o bonita*/ 
    .year-input{
      width:110px;
      background:#101318;     /* mismo gris que los botones */
      color:white;
      border:0;
      border-radius:8px;
      padding:10px 14px;
      font-weight:700;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      text-align:center;
    }

    .year-input:focus{
      outline:none;
      background:#2a3b4f;
    }

    .year-select:focus{ outline:none; }
    .year-select:hover{ background:#2a3b4f; }

    /* Bot√≥n gen√©rico (gris del sitio) */
    .btn-clean{
      display:inline-block;
      padding:12px 18px;
      background:#101318;           /* gris del pie */
      color:#fff;
      border:0;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      transition:background .2s ease, transform .05s ease;
    }
    .btn-clean:hover{ background:#2a3b4f; }
    .btn-clean:active{ transform:translateY(1px); }
    .btn-clean:disabled{ opacity:.5; cursor:not-allowed; }

    /* Variante grande para ‚ÄúIr a Pron√≥stico‚Äù */
    .btn-lg{ padding:14px 22px; font-size:1rem; }

    /* Selector A√±o/Mes en gris */
    .mode-switch{ display:inline-flex; border-radius:10px; overflow:hidden; }
    .mode-switch button{
      padding:12px 18px;
      background:#101318;
      color:#fff;
      border:none;
      font-weight:700;
      cursor:pointer;
    }
    .mode-switch button.active{ background:#2a3b4f; }
    .mode-switch button:not(.active):hover{ background:#2a3b4f; }

    .controls-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin:10px 0 14px;
    }

    /* Peque√±o espacio inferior para ‚Äúflotar‚Äù sobre la barra gris */
    .footer-spacer{ height:30px; }
  </style>

  <!-- Leaflet (mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>

<body style="background-image: url('{% static 'img/' %}{{ data.imagen_fondo }}'); background-size: cover; background-position: center;">
  <div class="card-container">
    <div class="card-detalle">

      <!-- Encabezado -->
      <div class="header-detalle">
        <h1>CLIMA CHILE - Resultados Detalle</h1>
        <div class="subtitle">
          An√°lisis Hist√≥rico - Regi√≥n de {{ data.region_nombre }} ({{ current_year }})
        </div>
      </div>

      <!-- Barra de modo + Ir a Pron√≥stico -->
      <div class="controls-row" style="justify-content:space-between; align-items:center;">
        <div class="mode-switch" id="modeSwitchHist">
          <button type="button" id="btnModeYear" class="active">A√±o</button>
          <button type="button" id="btnModeMonth">Mes</button>
        </div>

        <div style="display:flex; gap:10px;">
          <a class="btn-clean" href="{% url 'pronostico_detalle' %}">Ir a Pron√≥stico</a>
          <a class="btn-clean btn-lg" href="{% url 'evolucion_historica' %}">Ver Evoluci√≥n Hist√≥rica</a>
        </div>
      </div>

      <!-- Controles de A√ëO -->
      <div id="controlsYear">
        <!-- selector de a√±o XD-->
        <div class="controls-row">
          <label style="font-weight:700; opacity:.9; margin-right:6px;">A√±o:</label>
          <input 
            id="inputYear"
            class="year-input"
            type="number"
            min="1950"
            max="2025"
            step="1"
            value="{{ current_year }}"
          />
        </div>

        <!-- Botones a√±o anterior / siguiente -->
        <div class="controls-row">
          <button class="btn-clean" id="btnYearPrev">‚üµ A√±o anterior</button>
          <button class="btn-clean" id="btnYearNext">A√±o siguiente ‚ü∂</button>
        </div>
      </div>

      <!-- Controles de MES -->
      <div id="controlsMonth" style="display:none">
        <div class="controls-row">
          <button class="btn-clean" id="btnMonthPrev">‚üµ Mes anterior</button>
          <select id="selMonth" class="btn-clean" style="background:#101318; border-radius:8px;">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
          <button class="btn-clean" id="btnMonthNext">Mes siguiente ‚ü∂</button>
        </div>
        <div style="opacity:.75; font-weight:600;">
          Periodo: <span id="lblPeriodo">‚Äî</span>
        </div>
      </div>

      <!-- Cuerpo: Mapa + M√©tricas -->
      <div class="content-grid">
        <!-- Mapa -->
        <div class="left-column">
          <h3>üåç Ubicaci√≥n Geogr√°fica</h3>
          <div id="map" class="map-section"></div>
        </div>

        <!-- M√©tricas -->
        <div class="metric-grid-clean">
          <div class="data-panel-clean warm-bg">
            <span>T¬∞ M√ÅX PROMEDIO</span>
            <span id="temp_max_avg" class="metric-value-clean">--</span>
            <span class="unit">¬∞C</span>
          </div>
          <div class="data-panel-clean cold-bg">
            <span>T¬∞ M√çN PROMEDIO</span>
            <span id="temp_min_avg" class="metric-value-clean">--</span>
            <span class="unit">¬∞C</span>
          </div>
          <div class="data-panel-clean rain-bg">
            <span>PRECIPITACI√ìN SUMA</span>
            <span id="precip_sum" class="metric-value-clean">--</span>
            <span class="unit">mm</span>
          </div>
          <div class="data-panel-clean moisture-bg">
            <span>HUMEDAD M√ÅXIMA</span>
            <span id="humidity_max_abs" class="metric-value-clean">--</span>
            <span class="unit">%</span>
          </div>
          <div class="data-panel-clean wind-bg">
            <span>VIENTO M√ÅXIMO</span>
            <span id="wind_max" class="metric-value-clean">--</span>
            <span class="unit">km/h</span>
          </div>
          <div class="data-panel-clean sun-bg">
            <span>RADIACI√ìN SOLAR</span>
            <span id="radiation_sum" class="metric-value-clean">--</span>
            <span class="unit">J/m¬≤</span>
          </div>
          <div class="data-panel-clean extreme-bg">
            <span>T¬∞ M√ÅX ABSOLUTA</span>
            <span id="temp_max_abs" class="metric-value-clean">--</span>
            <span class="unit">¬∞C</span>
          </div>
          <div class="data-panel-clean cold-bg">
            <span>T¬∞ M√çN ABSOLUTA</span>
            <span id="temp_min_abs" class="metric-value-clean">--</span>
            <span class="unit">¬∞C</span>
          </div>
          <div class="data-panel-clean info-bg">
            <span>D√çAS EN EL PER√çODO</span>
            <span id="num_dias" class="metric-value-clean">--</span>
            <span class="unit">d√≠as</span>
          </div>
        </div>
      </div>

      <div class="footer-spacer"></div>
      <a href="{% url 'consulta_clima' %}" class="back-button">
        ‚Üê Volver a Nueva Consulta
      </a>

    </div>
  </div>

  <!-- === L√≥gica === -->
  <script>
    // Datos de contexto
    const REGION_CODE = "{{ data.region_code }}";
    const REGION_NAME = "{{ data.region_nombre }}";
    const LAT = {{ data.lat|floatformat:"6" }};
    const LON = {{ data.lon|floatformat:"6" }};
    let   curYear   = {{ current_year }};
    const LIMIT_END = "{{ limit_date }}"; // YYYY-MM-DD
    const MIN_YEAR  = 1950;
    const MAX_YEAR  = 2025;

    /* ---------- MAPA ---------- */
    (function initMap(){
      const map = L.map('map', {zoomControl:true}).setView([LAT, LON], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      const marker = L.marker([LAT, LON]).addTo(map);
      marker.bindPopup(`${REGION_NAME}`).openPopup();
      setTimeout(()=> map.invalidateSize(), 300);
    })();

    /* ---------- M√âTRICAS ---------- */
    function setMetric(id, v){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (v === null || v === undefined) ? '--' : v;
    }

    function paintMetrics(m){
      setMetric('temp_max_avg',      m.temp_max_avg);
      setMetric('temp_min_avg',      m.temp_min_avg);
      setMetric('precip_sum',        m.precip_sum);
      setMetric('wind_max',          m.wind_max);
      setMetric('radiation_sum',     m.radiation_sum);
      setMetric('temp_max_abs',      m.temp_max_abs);
      setMetric('temp_min_abs',      m.temp_min_abs);
      setMetric('humidity_max_abs',  m.humidity_max_abs);
      setMetric('num_dias',          m.num_dias);
    }

    async function callArchive(year, month){ // month: 0=anual; 1..12=mensual
      const res = await fetch("{% url 'fetch_clima_data_ajax' %}", {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          region_code: REGION_CODE,
          year:  year,
          month: month,
          is_forecast:false,
          period_end: LIMIT_END
        })
      });
      if(!res.ok) throw new Error('Error hist√≥rico');
      return res.json();
    }

    // --------- CARGA POR A√ëO ---------
    async function loadYear(y){
      curYear = y;

      const input = document.getElementById('inputYear');
      if(input) input.value = curYear;

      const r = await callArchive(y, 0);
      if(r?.success){
        paintMetrics(r.metrics);
        const lbl = document.getElementById('lblPeriodo');
        if(lbl) lbl.textContent = r.periodo_label || `Anual (${y})`;
      }
      updateYearButtons();
    }

    // --------- CARGA POR MES ---------
    async function loadMonth(m){
      // usa siempre el a√±o actual almacenado en curYear
      const r = await callArchive(curYear, m);
      if(r?.success){
        paintMetrics(r.metrics);
        const lbl = document.getElementById('lblPeriodo');
        if(lbl) lbl.textContent = r.periodo_label || `Mes ${m}`;
      }
      updateYearButtons();
    }

    /* ---------- MODO ---------- */
    const btnModeYear   = document.getElementById('btnModeYear');
    const btnModeMonth  = document.getElementById('btnModeMonth');
    const controlsYear  = document.getElementById('controlsYear');
    const controlsMonth = document.getElementById('controlsMonth');

    function setMode(mode){
      if(mode === 'year'){
        btnModeYear.classList.add('active');
        btnModeMonth.classList.remove('active');
        controlsYear.style.display  = 'block';
        controlsMonth.style.display = 'none';
        loadYear(curYear);
      } else {
        btnModeMonth.classList.add('active');
        btnModeYear.classList.remove('active');
        controlsMonth.style.display = 'block';
        controlsYear.style.display  = 'none';
        const sel = document.getElementById('selMonth');
        loadMonth(parseInt(sel.value || '1', 10));
      }
    }

    btnModeYear.onclick  = () => setMode('year');
    btnModeMonth.onclick = () => setMode('month');

    /* ---------- EVENTOS A√ëO ---------- */
    const btnYearPrev = document.getElementById('btnYearPrev');
    const btnYearNext = document.getElementById('btnYearNext');

    function updateYearButtons(){
      const btnYearPrevLocal = document.getElementById('btnYearPrev');
      const btnYearNextLocal = document.getElementById('btnYearNext');
      const inputYearLocal   = document.getElementById('inputYear');

      if(btnYearNextLocal) btnYearNextLocal.disabled = (curYear >= MAX_YEAR);
      if(btnYearPrevLocal) btnYearPrevLocal.disabled = (curYear <= MIN_YEAR);

      // Mantener el input sincronizado
      if(inputYearLocal && inputYearLocal.value !== String(curYear)){
        inputYearLocal.value = curYear;
      }
    }

    // Input manual de a√±o
    const inputYear = document.getElementById('inputYear');

    if(inputYear){
      inputYear.addEventListener('change', ()=>{
        let y = parseInt(inputYear.value, 10);
        if(isNaN(y)) return;

        y = Math.max(MIN_YEAR, Math.min(MAX_YEAR, y));
        inputYear.value = y;

        curYear = y;
        setMode('year');
        updateYearButtons();
      });

      inputYear.addEventListener('input', ()=>{
        if(inputYear.value.length > 4){
          inputYear.value = inputYear.value.slice(0,4);
        }
      });
    }

    btnYearPrev.onclick = ()=>{
      curYear--;
      setMode('year');
    };

    btnYearNext.onclick = ()=>{
      if(curYear < MAX_YEAR){
        curYear++;
        setMode('year');
      }
      updateYearButtons();
    };

    /* ---------- EVENTOS MES ---------- */
    const selMonth = document.getElementById('selMonth');

    document.getElementById('btnMonthPrev').onclick = ()=>{
      selMonth.value = Math.max(1, (parseInt(selMonth.value,10) || 1) - 1);
      loadMonth(parseInt(selMonth.value,10));
    };

    document.getElementById('btnMonthNext').onclick = ()=>{
      selMonth.value = Math.min(12, (parseInt(selMonth.value,10) || 1) + 1);
      loadMonth(parseInt(selMonth.value,10));
    };

    selMonth.onchange = ()=> loadMonth(parseInt(selMonth.value,10));

    /* ---------- INICIO ---------- */
    setMode('year');
  </script>
</body>
</html>
